<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ã‚³ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #0f1117; --surface: #1a1d27; --surface2: #242836;
  --text: #e8eaf0; --text-dim: #7a7f92;
  --court-a: #ff6b4a; --court-b: #4ac1ff; --court-c: #5bff7f; --court-d: #ffcc4a;
  --danger: #ff4a6b;
}
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
.nav-tabs { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: var(--surface); border-top: 1px solid rgba(255,255,255,0.06); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
.nav-tab { flex: 1; padding: 10px 0 8px; text-align: center; font-size: 11px; font-weight: 500; color: var(--text-dim); cursor: pointer; transition: color 0.2s; border: none; background: none; }
.nav-tab.active { color: var(--court-b); }
.nav-tab svg { display: block; margin: 0 auto 3px; width: 22px; height: 22px; }
.page { display: none; padding: 16px 16px 80px; min-height: 100vh; }
.page.active { display: block; }
.page-header { font-family: 'Oswald', sans-serif; font-size: 22px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 12px 0 16px; display: flex; align-items: center; gap: 10px; }
.page-header .icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
.audio-banner { padding: 12px 14px; border-radius: 10px; margin-bottom: 14px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.3s; }
.audio-banner.not-ready { background: rgba(255,107,74,0.15); border: 2px solid rgba(255,107,74,0.4); color: var(--court-a); }
.audio-banner.loading { background: rgba(255,204,74,0.12); border: 2px solid rgba(255,204,74,0.3); color: var(--court-d); }
.audio-banner.ready { background: rgba(91,255,127,0.08); border: 1px solid rgba(91,255,127,0.2); color: var(--court-c); font-size: 12px; font-weight: 500; cursor: default; }
.audio-banner svg { width: 20px; height: 20px; flex-shrink: 0; }
.court-card { background: var(--surface); border-radius: 14px; padding: 16px; margin-bottom: 14px; border-left: 4px solid var(--accent); position: relative; overflow: hidden; }
.court-card::before { content: attr(data-label); position: absolute; top: 8px; right: 12px; font-family: 'Oswald', sans-serif; font-size: 64px; font-weight: 700; color: rgba(255,255,255,0.03); line-height: 1; pointer-events: none; }
.court-label { font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.court-label .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
.court-label .status { font-family: 'Noto Sans JP', sans-serif; font-size: 10px; font-weight: 500; letter-spacing: 0; text-transform: none; color: var(--text-dim); margin-left: auto; }
.court-label .status.running { color: var(--court-c); }
.court-label .status.paused { color: var(--court-d); }
.timer-display { font-family: 'Oswald', sans-serif; font-size: 52px; font-weight: 700; letter-spacing: 3px; text-align: center; padding: 8px 0 14px; color: var(--text); font-variant-numeric: tabular-nums; }
.timer-display.running { color: #fff; }
.court-buttons { display: flex; gap: 8px; }
.court-btn { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-family: 'Noto Sans JP', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.15s; }
.court-btn:active { transform: scale(0.96); }
.btn-start { background: rgba(91,255,127,0.15); color: var(--court-c); border: 1px solid rgba(91,255,127,0.25); }
.btn-pause { background: rgba(255,204,74,0.15); color: var(--court-d); border: 1px solid rgba(255,204,74,0.25); }
.btn-reset { background: rgba(255,74,107,0.1); color: var(--danger); border: 1px solid rgba(255,74,107,0.2); }
.next-announce { margin-top: 10px; padding: 8px 12px; background: var(--surface2); border-radius: 8px; font-size: 12px; color: var(--text-dim); display: flex; align-items: center; gap: 6px; }
.next-announce svg { width: 14px; height: 14px; flex-shrink: 0; }
.next-announce .time { color: var(--text); font-weight: 700; font-family: 'Oswald', sans-serif; letter-spacing: 1px; }
.settings-section { background: var(--surface); border-radius: 14px; padding: 16px; margin-bottom: 14px; }
.settings-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.settings-title .badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
.file-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.file-row:last-child { margin-bottom: 0; }
.file-label { font-size: 12px; font-weight: 700; min-width: 70px; }
.file-input-wrap { flex: 1; }
.file-name { font-size: 12px; padding: 10px 12px; background: var(--surface2); border-radius: 8px; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; border: 1px solid transparent; }
.file-name.loaded { color: var(--text); border-color: rgba(91,255,127,0.3); }
input[type="file"] { display: none; }
.help-text { font-size: 11px; color: var(--text-dim); line-height: 1.6; margin-top: 12px; padding: 10px; background: var(--surface2); border-radius: 8px; }
.help-text code { background: rgba(74,193,255,0.1); color: var(--court-b); padding: 1px 5px; border-radius: 3px; font-size: 11px; }
.action-btn { display: block; width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; border: none; }
.action-btn:active { transform: scale(0.97); }
.btn-test { background: rgba(74,193,255,0.1); border: 1px solid rgba(74,193,255,0.25); color: var(--court-b); }
.btn-danger { background: rgba(255,74,107,0.1); border: 1px solid rgba(255,74,107,0.2); color: var(--danger); }
.log-list { display: flex; flex-direction: column; gap: 4px; }
.log-entry { padding: 10px 12px; background: var(--surface); border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 10px; }
.log-time { font-family: 'Oswald', sans-serif; font-size: 12px; color: var(--text-dim); min-width: 55px; }
.log-court { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; color: #fff; }
.log-msg { color: var(--text); flex: 1; }
.log-empty { text-align: center; padding: 40px 0; color: var(--text-dim); font-size: 13px; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
.running-indicator { animation: pulse 1.5s ease-in-out infinite; }
.toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--surface2); color: var(--text); padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 500; z-index: 200; transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 8px 30px rgba(0,0,0,0.4); pointer-events: none; max-width: 90vw; text-align: center; }
.toast.show { transform: translateX(-50%) translateY(0); }
.storage-info { font-size: 11px; color: var(--text-dim); text-align: center; padding: 8px; }
</style>
</head>
<body>

<div class="page active" id="page-timer">
  <div class="page-header">
    <div class="icon" style="background:var(--court-b)"><svg width="16" height="16" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M9 1h6"/></svg></div>
    ã‚³ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼
  </div>
  <div class="audio-banner not-ready" id="audio-banner" onclick="initAudio()">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
    <span id="audio-banner-text">ğŸ”ˆ ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦éŸ³å£°ã‚’æœ‰åŠ¹åŒ–</span>
  </div>
  <div id="courts-container"></div>
</div>

<div class="page" id="page-settings">
  <div class="page-header">
    <div class="icon" style="background:var(--court-d)"><svg width="16" height="16" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.32 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    è¨­å®š
  </div>
  <div class="settings-section">
    <div class="settings-title"><svg width="16" height="16" fill="none" stroke="var(--court-b)" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«<span class="badge" style="background:rgba(74,193,255,0.15);color:var(--court-b)">.txt</span></div>
    <div id="schedule-inputs"></div>
    <div class="help-text">å„ã‚³ãƒ¼ãƒˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.txtï¼‰ã‚’é¸æŠã€‚<br>å½¢å¼: <code>00:25:00âŸ¨TABâŸ©A25åˆ†.mp3</code><br>ğŸ’¾ ä¸€åº¦èª­ã¿è¾¼ã‚ã°æ¬¡å›ã‹ã‚‰è‡ªå‹•å¾©å…ƒã€‚</div>
  </div>
  <div class="settings-section">
    <div class="settings-title"><svg width="16" height="16" fill="none" stroke="var(--court-c)" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«<span class="badge" style="background:rgba(91,255,127,0.15);color:var(--court-c)">.mp3</span></div>
    <div class="file-row">
      <div class="file-label" style="color:var(--text-dim)">MP3é¸æŠ</div>
      <div class="file-input-wrap">
        <div class="file-name" id="mp3-file-label" onclick="document.getElementById('mp3-input').click()">ã‚¿ãƒƒãƒ—ã—ã¦MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
        <input type="file" id="mp3-input" accept=".mp3,audio/*" multiple onchange="handleMp3Files(this)">
      </div>
    </div>
    <div id="mp3-list" style="margin-top:8px"></div>
    <div class="help-text">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§æŒ‡å®šã•ã‚ŒãŸMP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦é¸æŠã€‚<br>ğŸ’¾ ä¸€åº¦èª­ã¿è¾¼ã‚ã°æ¬¡å›ã‹ã‚‰è‡ªå‹•å¾©å…ƒã€‚</div>
    <button class="action-btn btn-test" onclick="testAudio()">ğŸ”Š éŸ³å£°ãƒ†ã‚¹ãƒˆå†ç”Ÿ</button>
  </div>
  <div class="settings-section">
    <div class="settings-title" style="color:var(--danger)"><svg width="16" height="16" fill="none" stroke="var(--danger)" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <div id="storage-info" class="storage-info">ç¢ºèªä¸­...</div>
    <button class="action-btn btn-danger" onclick="clearAllData()">ğŸ—‘ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤</button>
  </div>
</div>

<div class="page" id="page-log">
  <div class="page-header">
    <div class="icon" style="background:var(--court-a)"><svg width="16" height="16" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
    å†ç”Ÿãƒ­ã‚°
  </div>
  <div id="log-container"><div class="log-empty">ã¾ã å†ç”Ÿè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
  <button class="action-btn btn-danger" onclick="clearLog()">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
</div>

<div class="nav-tabs">
  <button class="nav-tab active" onclick="switchPage('timer')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M9 1h6"/></svg>ã‚¿ã‚¤ãƒãƒ¼</button>
  <button class="nav-tab" onclick="switchPage('settings')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.32 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>è¨­å®š</button>
  <button class="nav-tab" onclick="switchPage('log')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>ãƒ­ã‚°</button>
</div>
<div class="toast" id="toast"></div>

<script>
// ===============================================
// IndexedDB
// ===============================================
var DB_NAME = 'CourtTimerDB', DB_VERSION = 1, db = null;
function openDB() {
  return new Promise(function(ok, ng) {
    var r = indexedDB.open(DB_NAME, DB_VERSION);
    r.onupgradeneeded = function(e) {
      var d = e.target.result;
      if (!d.objectStoreNames.contains('schedules')) d.createObjectStore('schedules', { keyPath: 'courtId' });
      if (!d.objectStoreNames.contains('mp3files')) d.createObjectStore('mp3files', { keyPath: 'name' });
    };
    r.onsuccess = function(e) { db = e.target.result; ok(db); };
    r.onerror = ng;
  });
}
function dbPut(s, d) { return new Promise(function(ok, ng) { var t = db.transaction(s,'readwrite'); t.objectStore(s).put(d); t.oncomplete = ok; t.onerror = ng; }); }
function dbGetAll(s) { return new Promise(function(ok, ng) { var t = db.transaction(s,'readonly'); var r = t.objectStore(s).getAll(); r.onsuccess = function(){ok(r.result);}; r.onerror = ng; }); }
function dbClear(s) { return new Promise(function(ok, ng) { var t = db.transaction(s,'readwrite'); t.objectStore(s).clear(); t.oncomplete = ok; t.onerror = ng; }); }

async function loadSavedData() {
  try {
    var schedules = await dbGetAll('schedules');
    schedules.forEach(function(s) {
      if (state.courts[s.courtId]) {
        state.courts[s.courtId].announcements = s.announcements;
        state.courts[s.courtId].announced = new Set();
        var l = document.getElementById('sched-label-' + s.courtId);
        l.textContent = s.fileName + ' ğŸ’¾'; l.classList.add('loaded');
        updateNextAnnounce(s.courtId);
      }
    });
    var mp3s = await dbGetAll('mp3files');
    mp3s.forEach(function(m) { state.mp3Raw[m.name] = m.data; });
    if (mp3s.length > 0) {
      document.getElementById('mp3-file-label').textContent = mp3s.length + 'å€‹ã®MP3 (ğŸ’¾ ä¿å­˜æ¸ˆ)';
      document.getElementById('mp3-file-label').classList.add('loaded');
      renderMp3List();
    }
    updateStorageInfo();
    if (schedules.length > 0 || mp3s.length > 0) showToast('ğŸ’¾ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
  } catch (e) { console.warn('Load failed:', e); }
}
async function updateStorageInfo() {
  try {
    var sc = await dbGetAll('schedules'), mp = await dbGetAll('mp3files'), sz = 0;
    mp.forEach(function(m) { sz += m.data.byteLength; });
    document.getElementById('storage-info').textContent = 'ğŸ’¾ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: ' + sc.length + 'ä»¶ / MP3: ' + mp.length + 'ä»¶ (' + (sz/1048576).toFixed(1) + 'MB)';
  } catch (e) { document.getElementById('storage-info').textContent = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—'; }
}
async function clearAllData() {
  if (!confirm('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await dbClear('schedules'); await dbClear('mp3files');
  state.mp3Raw = {}; state.mp3Decoded = {};
  COURTS.forEach(function(c) {
    state.courts[c.id].announcements = []; state.courts[c.id].announced = new Set();
    var l = document.getElementById('sched-label-' + c.id); l.textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ'; l.classList.remove('loaded');
    updateNextAnnounce(c.id);
  });
  document.getElementById('mp3-file-label').textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰';
  document.getElementById('mp3-file-label').classList.remove('loaded');
  document.getElementById('mp3-list').innerHTML = '';
  updateStorageInfo(); showToast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===============================================
// State
// ===============================================
var COURTS = [
  { id: 'court1', name: 'A', label: 'Aã‚³ãƒ¼ãƒˆ', color: '--court-a' },
  { id: 'court2', name: 'B', label: 'Bã‚³ãƒ¼ãƒˆ', color: '--court-b' },
  { id: 'court3', name: 'C', label: 'Cã‚³ãƒ¼ãƒˆ', color: '--court-c' },
  { id: 'court4', name: 'D', label: 'Dã‚³ãƒ¼ãƒˆ', color: '--court-d' },
];
var state = { courts: {}, mp3Raw: {}, mp3Decoded: {}, logs: [] };

// ===============================================
// Audio System - Pure Web Audio API
//
// Strategy:
// 1. User taps â†’ create AudioContext + resume (unlocks on iOS)
// 2. Play a tiny silent buffer (confirms unlock)
// 3. Decode all MP3 ArrayBuffers â†’ AudioBuffer
// 4. Timer playback: BufferSource.start() works from setInterval
//    because AudioContext is already unlocked
//
// NO HTML Audio elements used at all.
// ===============================================
var audioCtx = null;
var audioState = 'not-ready'; // not-ready | loading | ready

async function initAudio() {
  if (audioState === 'ready') return;
  if (audioState === 'loading') return;

  setBannerState('loading', 'â³ éŸ³å£°ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­...');

  // Step 1: Create & unlock AudioContext (resume from user gesture is enough for iOS)
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  await audioCtx.resume();

  // Step 2: Decode all MP3 ArrayBuffers
  var names = Object.keys(state.mp3Raw);
  var decoded = 0;
  var failed = 0;

  for (var i = 0; i < names.length; i++) {
    var name = names[i];
    if (state.mp3Decoded[name]) { decoded++; continue; }
    try {
      // decodeAudioData detaches the buffer, so use a copy
      var copy = state.mp3Raw[name].slice(0);
      state.mp3Decoded[name] = await audioCtx.decodeAudioData(copy);
      decoded++;
    } catch (e) {
      console.warn('Decode failed:', name, e);
      failed++;
    }
    setBannerState('loading', 'â³ ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­... ' + decoded + '/' + names.length);
  }

  audioState = 'ready';
  var msg = 'âœ“ éŸ³å£°æœ‰åŠ¹ï¼ˆ' + decoded + 'å€‹ãƒ‡ã‚³ãƒ¼ãƒ‰æ¸ˆï¼‰';
  if (failed > 0) msg += ' âš ' + failed + 'å€‹å¤±æ•—';
  setBannerState('ready', msg);
  showToast('ğŸ”Š éŸ³å£°æœ‰åŠ¹åŒ–å®Œäº†ï¼');
}

function setBannerState(s, text) {
  var banner = document.getElementById('audio-banner');
  var textEl = document.getElementById('audio-banner-text');
  banner.className = 'audio-banner ' + s;
  textEl.textContent = text;
  if (s === 'ready') banner.onclick = null;
}

function playAudio(fileName, courtId) {
  if (!state.mp3Decoded[fileName]) {
    addLog(courtId, 'âš  æœªãƒ‡ã‚³ãƒ¼ãƒ‰: ' + fileName);
    return;
  }
  if (!audioCtx || audioState !== 'ready') {
    addLog(courtId, 'âš  éŸ³å£°æœªæœ‰åŠ¹åŒ–');
    return;
  }
  // Resume if suspended (e.g. after screen lock)
  if (audioCtx.state === 'suspended') audioCtx.resume();

  // Create a new BufferSource each time (they are one-shot)
  var source = audioCtx.createBufferSource();
  source.buffer = state.mp3Decoded[fileName];
  source.connect(audioCtx.destination);
  source.start(0);
  addLog(courtId, 'â™ª ' + fileName);
}

function testAudio() {
  // initAudio must be called from user gesture
  initAudio().then(function() {
    var names = Object.keys(state.mp3Decoded);
    if (names.length === 0) { showToast('âš  MP3ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
    var name = names[0];
    var source = audioCtx.createBufferSource();
    source.buffer = state.mp3Decoded[name];
    source.connect(audioCtx.destination);
    source.start(0);
    showToast('ğŸ”Š ãƒ†ã‚¹ãƒˆ: ' + name);
  });
}

// ===============================================
// Init UI
// ===============================================
function initUI() {
  var c = document.getElementById('courts-container');
  var si = document.getElementById('schedule-inputs');
  COURTS.forEach(function(ct) {
    state.courts[ct.id] = { timer: null, elapsed: 0, status: 'stopped', announcements: [], announced: new Set() };
    var card = document.createElement('div');
    card.className = 'court-card'; card.style.setProperty('--accent','var('+ct.color+')'); card.setAttribute('data-label',ct.name);
    card.innerHTML = '<div class="court-label"><span class="dot"></span>'+ct.label+'<span class="status" id="status-'+ct.id+'">åœæ­¢ä¸­</span></div>'+
      '<div class="timer-display" id="timer-'+ct.id+'">00:00:00</div>'+
      '<div class="court-buttons">'+
      '<button class="court-btn btn-start" onclick="startCourt(\''+ct.id+'\')">â–¶ é–‹å§‹</button>'+
      '<button class="court-btn btn-pause" onclick="pauseCourt(\''+ct.id+'\')">â¸ ä¸€æ™‚åœæ­¢</button>'+
      '<button class="court-btn btn-reset" onclick="resetCourt(\''+ct.id+'\')">â†º ãƒªã‚»ãƒƒãƒˆ</button></div>'+
      '<div class="next-announce" id="next-'+ct.id+'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg><span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœªè¨­å®š</span></div>';
    c.appendChild(card);
    var row = document.createElement('div'); row.className = 'file-row';
    row.innerHTML = '<div class="file-label" style="color:var('+ct.color+');font-family:Oswald,sans-serif;letter-spacing:1px">'+ct.label+'</div>'+
      '<div class="file-input-wrap"><div class="file-name" id="sched-label-'+ct.id+'" onclick="document.getElementById(\'sched-input-'+ct.id+'\').click()">ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</div>'+
      '<input type="file" id="sched-input-'+ct.id+'" accept=".txt,text/plain" onchange="handleScheduleFile(\''+ct.id+'\',this)"></div>';
    si.appendChild(row);
  });
}

// ===============================================
// Helpers
// ===============================================
function formatTime(s){return String(Math.floor(s/3600)).padStart(2,'0')+':'+String(Math.floor((s%3600)/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');}
function parseTime(s){var p=s.trim().split(':');if(p.length===3)return+p[0]*3600+ +p[1]*60+ +p[2];if(p.length===2)return+p[0]*60+ +p[1];return 0;}
function getCourtLabel(id){var c=COURTS.find(function(x){return x.id===id;});return c?c.label:id;}

// ===============================================
// File Handling
// ===============================================
function handleScheduleFile(courtId, input) {
  var file = input.files[0]; if (!file) return;
  var fn = file.name, reader = new FileReader();
  reader.onload = function(e) {
    var anns = [];
    e.target.result.split('\n').forEach(function(line) {
      line = line.trim(); if (!line) return;
      var p = line.split('\t');
      if (p.length >= 2) anns.push({ time: parseTime(p[0]), timeStr: p[0].trim(), fileName: p[1].trim() });
    });
    anns.sort(function(a,b){return a.time-b.time;});
    state.courts[courtId].announcements = anns; state.courts[courtId].announced = new Set();
    dbPut('schedules',{courtId:courtId,fileName:fn,announcements:anns}).then(updateStorageInfo);
    var l = document.getElementById('sched-label-'+courtId); l.textContent = fn+' ğŸ’¾'; l.classList.add('loaded');
    updateNextAnnounce(courtId);
    showToast(getCourtLabel(courtId)+' ä¿å­˜å®Œäº†ï¼ˆ'+anns.length+'ä»¶ï¼‰');
  };
  reader.readAsText(file,'UTF-8');
}
function handleMp3Files(input) {
  var files = input.files; if (!files.length) return;
  var loaded = 0, total = files.length;
  for (var i = 0; i < files.length; i++) {
    (function(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        state.mp3Raw[file.name] = e.target.result;
        dbPut('mp3files',{name:file.name,data:e.target.result});
        loaded++;
        if (loaded === total) {
          document.getElementById('mp3-file-label').textContent = Object.keys(state.mp3Raw).length+'å€‹ã®MP3 (ğŸ’¾ ä¿å­˜æ¸ˆ)';
          document.getElementById('mp3-file-label').classList.add('loaded');
          renderMp3List(); updateStorageInfo();
          showToast(total+'å€‹ã®MP3ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          // Need to re-decode new files
          if (audioState === 'ready') { audioState = 'not-ready'; setBannerState('not-ready','ğŸ”ˆ æ–°ã—ã„MP3è¿½åŠ  â†’ ã‚¿ãƒƒãƒ—ã—ã¦å†æœ‰åŠ¹åŒ–'); }
        }
      };
      reader.readAsArrayBuffer(file);
    })(files[i]);
  }
}
function renderMp3List() {
  document.getElementById('mp3-list').innerHTML = Object.keys(state.mp3Raw).map(function(n){
    return '<div style="font-size:11px;color:var(--text-dim);padding:3px 0">âœ“ '+n+' ('+(state.mp3Raw[n].byteLength/1048576).toFixed(2)+'MB)</div>';
  }).join('');
}

// ===============================================
// Timer
// ===============================================
function startCourt(courtId) {
  var court = state.courts[courtId];
  if (court.status === 'running') return;
  // initAudio on user gesture
  initAudio();
  court.status = 'running';
  court.timer = setInterval(function(){tick(courtId);},1000);
  checkAnnouncements(courtId);
  updateCourtUI(courtId);
}
function pauseCourt(courtId) {
  var court = state.courts[courtId];
  if (court.status !== 'running') return;
  court.status = 'paused'; clearInterval(court.timer); court.timer = null;
  updateCourtUI(courtId);
}
function resetCourt(courtId) {
  var court = state.courts[courtId]; court.status = 'stopped';
  if (court.timer) clearInterval(court.timer); court.timer = null;
  court.elapsed = 0; court.announced = new Set();
  updateCourtUI(courtId);
}
function tick(courtId) {
  var court = state.courts[courtId]; court.elapsed++;
  document.getElementById('timer-'+courtId).textContent = formatTime(court.elapsed);
  checkAnnouncements(courtId);
  if (court.announcements.length > 0) {
    var last = court.announcements[court.announcements.length-1].time;
    if (court.elapsed >= last) setTimeout(function(){resetCourt(courtId);},3000);
  }
  updateNextAnnounce(courtId);
}
function checkAnnouncements(courtId) {
  var court = state.courts[courtId];
  court.announcements.forEach(function(ann) {
    if (ann.time === court.elapsed && !court.announced.has(ann.time)) {
      court.announced.add(ann.time);
      playAudio(ann.fileName, courtId);
    }
  });
}

// ===============================================
// UI
// ===============================================
function updateCourtUI(courtId) {
  var court = state.courts[courtId];
  var te = document.getElementById('timer-'+courtId), se = document.getElementById('status-'+courtId);
  te.textContent = formatTime(court.elapsed);
  te.className = 'timer-display'+(court.status==='running'?' running':'');
  if (court.status==='running'){se.textContent='è¨ˆæ¸¬ä¸­';se.className='status running running-indicator';}
  else if(court.status==='paused'){se.textContent='ä¸€æ™‚åœæ­¢';se.className='status paused';}
  else{se.textContent='åœæ­¢ä¸­';se.className='status';}
  updateNextAnnounce(courtId);
}
function updateNextAnnounce(courtId) {
  var court = state.courts[courtId], el = document.getElementById('next-'+courtId), anns = court.announcements;
  var svg = '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
  if (!anns.length){el.innerHTML=svg+'<span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœªè¨­å®š</span>';return;}
  var next = anns.find(function(a){return a.time>court.elapsed;});
  if(next){el.innerHTML=svg+' æ¬¡: <span class="time">'+next.timeStr+'</span> â†’ '+next.fileName;}
  else{el.innerHTML=svg+'<span>å…¨ã‚¢ãƒŠã‚¦ãƒ³ã‚¹å®Œäº†</span>';}
}

// ===============================================
// Log
// ===============================================
function addLog(courtId,msg){
  var ct=COURTS.find(function(c){return c.id===courtId;}),now=new Date();
  var t=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');
  state.logs.unshift({courtName:ct.name,color:ct.color,time:t,message:msg});renderLogs();
}
function renderLogs(){
  var c=document.getElementById('log-container');
  if(!state.logs.length){c.innerHTML='<div class="log-empty">ã¾ã å†ç”Ÿè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>';return;}
  c.innerHTML='<div class="log-list">'+state.logs.map(function(l){
    return '<div class="log-entry"><span class="log-time">'+l.time+'</span><span class="log-court" style="background:var('+l.color+')">'+l.courtName+'</span><span class="log-msg">'+l.message+'</span></div>';
  }).join('')+'</div>';
}
function clearLog(){state.logs=[];renderLogs();}

// ===============================================
// Nav, Toast, WakeLock
// ===============================================
function switchPage(p){
  document.querySelectorAll('.page').forEach(function(x){x.classList.remove('active');});
  document.querySelectorAll('.nav-tab').forEach(function(x){x.classList.remove('active');});
  document.getElementById('page-'+p).classList.add('active');
  document.querySelectorAll('.nav-tab')[['timer','settings','log'].indexOf(p)].classList.add('active');
}
function showToast(m){var e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(function(){e.classList.remove('show');},2500);}
async function requestWakeLock(){try{if('wakeLock' in navigator)await navigator.wakeLock.request('screen');}catch(e){}}

// ===============================================
// Boot
// ===============================================
initUI();
openDB().then(function(){loadSavedData();});
requestWakeLock();
document.addEventListener('visibilitychange',function(){if(document.visibilityState==='visible')requestWakeLock();});
</script>
</body>
</html>
