<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ã‚³ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #0f1117; --surface: #1a1d27; --surface2: #242836;
  --text: #e8eaf0; --text-dim: #7a7f92;
  --court-a: #ff6b4a; --court-b: #4ac1ff; --court-c: #5bff7f; --court-d: #ffcc4a;
  --danger: #ff4a6b;
}
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
.nav-tabs { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: var(--surface); border-top: 1px solid rgba(255,255,255,0.06); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
.nav-tab { flex: 1; padding: 10px 0 8px; text-align: center; font-size: 11px; font-weight: 500; color: var(--text-dim); cursor: pointer; transition: color 0.2s; border: none; background: none; }
.nav-tab.active { color: var(--court-b); }
.nav-tab svg { display: block; margin: 0 auto 3px; width: 22px; height: 22px; }
.page { display: none; padding: 16px 16px 80px; min-height: 100vh; }
.page.active { display: block; }
.page-header { font-family: 'Oswald', sans-serif; font-size: 22px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 12px 0 16px; display: flex; align-items: center; gap: 10px; }
.page-header .icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
.audio-banner { padding: 12px 14px; border-radius: 10px; margin-bottom: 14px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px; cursor: pointer; }
.audio-banner.not-ready { background: rgba(255,107,74,0.15); border: 2px solid rgba(255,107,74,0.4); color: var(--court-a); }
.audio-banner.ready { background: rgba(91,255,127,0.08); border: 1px solid rgba(91,255,127,0.2); color: var(--court-c); font-size: 12px; font-weight: 500; }
.audio-banner svg { width: 20px; height: 20px; flex-shrink: 0; }
.court-card { background: var(--surface); border-radius: 14px; padding: 16px; margin-bottom: 14px; border-left: 4px solid var(--accent); position: relative; overflow: hidden; }
.court-card::before { content: attr(data-label); position: absolute; top: 8px; right: 12px; font-family: 'Oswald', sans-serif; font-size: 64px; font-weight: 700; color: rgba(255,255,255,0.03); line-height: 1; pointer-events: none; }
.court-label { font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.court-label .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
.court-label .status { font-family: 'Noto Sans JP', sans-serif; font-size: 10px; font-weight: 500; letter-spacing: 0; text-transform: none; color: var(--text-dim); margin-left: auto; }
.court-label .status.running { color: var(--court-c); }
.court-label .status.paused { color: var(--court-d); }
.timer-display { font-family: 'Oswald', sans-serif; font-size: 52px; font-weight: 700; letter-spacing: 3px; text-align: center; padding: 8px 0 14px; color: var(--text); font-variant-numeric: tabular-nums; }
.timer-display.running { color: #fff; }
.court-buttons { display: flex; gap: 8px; }
.court-btn { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-family: 'Noto Sans JP', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.15s; color: #fff; }
.court-btn:active { transform: scale(0.96); }
.btn-start { background: rgba(91,255,127,0.15); color: var(--court-c); border: 1px solid rgba(91,255,127,0.25); }
.btn-pause { background: rgba(255,204,74,0.15); color: var(--court-d); border: 1px solid rgba(255,204,74,0.25); }
.btn-reset { background: rgba(255,74,107,0.1); color: var(--danger); border: 1px solid rgba(255,74,107,0.2); }
.next-announce { margin-top: 10px; padding: 8px 12px; background: var(--surface2); border-radius: 8px; font-size: 12px; color: var(--text-dim); display: flex; align-items: center; gap: 6px; }
.next-announce svg { width: 14px; height: 14px; flex-shrink: 0; }
.next-announce .time { color: var(--text); font-weight: 700; font-family: 'Oswald', sans-serif; letter-spacing: 1px; }
.settings-section { background: var(--surface); border-radius: 14px; padding: 16px; margin-bottom: 14px; }
.settings-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.settings-title .badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
.file-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.file-row:last-child { margin-bottom: 0; }
.file-label { font-size: 12px; font-weight: 700; min-width: 70px; color: var(--text-dim); }
.file-input-wrap { flex: 1; }
.file-name { font-size: 12px; padding: 10px 12px; background: var(--surface2); border-radius: 8px; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s; }
.file-name.loaded { color: var(--text); border-color: rgba(91,255,127,0.3); }
input[type="file"] { display: none; }
.help-text { font-size: 11px; color: var(--text-dim); line-height: 1.6; margin-top: 12px; padding: 10px; background: var(--surface2); border-radius: 8px; }
.help-text code { background: rgba(74,193,255,0.1); color: var(--court-b); padding: 1px 5px; border-radius: 3px; font-size: 11px; }
.action-btn { display: block; width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; border: none; }
.action-btn:active { transform: scale(0.97); }
.btn-test { background: rgba(74,193,255,0.1); border: 1px solid rgba(74,193,255,0.25); color: var(--court-b); }
.btn-danger { background: rgba(255,74,107,0.1); border: 1px solid rgba(255,74,107,0.2); color: var(--danger); }
.log-list { display: flex; flex-direction: column; gap: 4px; }
.log-entry { padding: 10px 12px; background: var(--surface); border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 10px; }
.log-time { font-family: 'Oswald', sans-serif; font-size: 12px; color: var(--text-dim); min-width: 55px; letter-spacing: 0.5px; }
.log-court { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; color: #fff; }
.log-msg { color: var(--text); flex: 1; }
.log-empty { text-align: center; padding: 40px 0; color: var(--text-dim); font-size: 13px; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.running-indicator { animation: pulse 1.5s ease-in-out infinite; }
.toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--surface2); color: var(--text); padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 500; z-index: 200; transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 8px 30px rgba(0,0,0,0.4); pointer-events: none; max-width: 90vw; text-align: center; }
.toast.show { transform: translateX(-50%) translateY(0); }
.storage-info { font-size: 11px; color: var(--text-dim); text-align: center; padding: 8px; }
</style>
</head>
<body>

<div class="page active" id="page-timer">
  <div class="page-header">
    <div class="icon" style="background: var(--court-b)"><svg width="16" height="16" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M9 1h6"/></svg></div>
    ã‚³ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼
  </div>
  <div class="audio-banner not-ready" id="audio-banner" onclick="initAudio()">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
    <span id="audio-banner-text">ğŸ”ˆ ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦éŸ³å£°ã‚’æœ‰åŠ¹åŒ–</span>
  </div>
  <div id="courts-container"></div>
</div>

<div class="page" id="page-settings">
  <div class="page-header">
    <div class="icon" style="background: var(--court-d)"><svg width="16" height="16" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.32 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    è¨­å®š
  </div>
  <div class="settings-section">
    <div class="settings-title">
      <svg width="16" height="16" fill="none" stroke="var(--court-b)" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«
      <span class="badge" style="background: rgba(74,193,255,0.15); color: var(--court-b);">.txt</span>
    </div>
    <div id="schedule-inputs"></div>
    <div class="help-text">å„ã‚³ãƒ¼ãƒˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.txtï¼‰ã‚’é¸æŠã€‚<br>å½¢å¼: <code>00:25:00âŸ¨TABâŸ©A25åˆ†.mp3</code><br>ğŸ’¾ ä¸€åº¦èª­ã¿è¾¼ã‚ã°æ¬¡å›ã‹ã‚‰è‡ªå‹•å¾©å…ƒã•ã‚Œã¾ã™ã€‚</div>
  </div>
  <div class="settings-section">
    <div class="settings-title">
      <svg width="16" height="16" fill="none" stroke="var(--court-c)" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«
      <span class="badge" style="background: rgba(91,255,127,0.15); color: var(--court-c);">.mp3</span>
    </div>
    <div class="file-row">
      <div class="file-label">MP3é¸æŠ</div>
      <div class="file-input-wrap">
        <div class="file-name" id="mp3-file-label" onclick="document.getElementById('mp3-input').click()">ã‚¿ãƒƒãƒ—ã—ã¦MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
        <input type="file" id="mp3-input" accept=".mp3,audio/*" multiple onchange="handleMp3Files(this)">
      </div>
    </div>
    <div id="mp3-list" style="margin-top: 8px;"></div>
    <div class="help-text">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§æŒ‡å®šã•ã‚ŒãŸMP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦é¸æŠã€‚<br>ğŸ’¾ ä¸€åº¦èª­ã¿è¾¼ã‚ã°æ¬¡å›ã‹ã‚‰è‡ªå‹•å¾©å…ƒã•ã‚Œã¾ã™ã€‚</div>
    <button class="action-btn btn-test" onclick="testAudio()">ğŸ”Š éŸ³å£°ãƒ†ã‚¹ãƒˆå†ç”Ÿ</button>
  </div>
  <div class="settings-section">
    <div class="settings-title" style="color: var(--danger);">
      <svg width="16" height="16" fill="none" stroke="var(--danger)" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    </div>
    <div id="storage-info" class="storage-info">ç¢ºèªä¸­...</div>
    <button class="action-btn btn-danger" onclick="clearAllData()">ğŸ—‘ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤</button>
  </div>
</div>

<div class="page" id="page-log">
  <div class="page-header">
    <div class="icon" style="background: var(--court-a)"><svg width="16" height="16" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
    å†ç”Ÿãƒ­ã‚°
  </div>
  <div id="log-container"><div class="log-empty">ã¾ã ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã®å†ç”Ÿè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
  <button class="action-btn btn-danger" onclick="clearLog()">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
</div>

<div class="nav-tabs">
  <button class="nav-tab active" onclick="switchPage('timer')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M9 1h6"/></svg>ã‚¿ã‚¤ãƒãƒ¼</button>
  <button class="nav-tab" onclick="switchPage('settings')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.32 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>è¨­å®š</button>
  <button class="nav-tab" onclick="switchPage('log')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>ãƒ­ã‚°</button>
</div>
<div class="toast" id="toast"></div>

<script>
// ===============================================
// IndexedDB
// ===============================================
var DB_NAME = 'CourtTimerDB';
var DB_VERSION = 1;
var db = null;

function openDB() {
  return new Promise(function(resolve, reject) {
    var req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = function(e) {
      var d = e.target.result;
      if (!d.objectStoreNames.contains('schedules')) d.createObjectStore('schedules', { keyPath: 'courtId' });
      if (!d.objectStoreNames.contains('mp3files')) d.createObjectStore('mp3files', { keyPath: 'name' });
    };
    req.onsuccess = function(e) { db = e.target.result; resolve(db); };
    req.onerror = function(e) { reject(e); };
  });
}

function dbPut(store, data) {
  return new Promise(function(resolve, reject) {
    var tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(data);
    tx.oncomplete = resolve;
    tx.onerror = reject;
  });
}

function dbGetAll(store) {
  return new Promise(function(resolve, reject) {
    var tx = db.transaction(store, 'readonly');
    var req = tx.objectStore(store).getAll();
    req.onsuccess = function() { resolve(req.result); };
    req.onerror = reject;
  });
}

function dbClear(store) {
  return new Promise(function(resolve, reject) {
    var tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete = resolve;
    tx.onerror = reject;
  });
}

async function loadSavedData() {
  try {
    var schedules = await dbGetAll('schedules');
    schedules.forEach(function(s) {
      if (state.courts[s.courtId]) {
        state.courts[s.courtId].announcements = s.announcements;
        state.courts[s.courtId].announced = new Set();
        var label = document.getElementById('sched-label-' + s.courtId);
        label.textContent = s.fileName + ' ğŸ’¾';
        label.classList.add('loaded');
        updateNextAnnounce(s.courtId);
      }
    });
    var mp3s = await dbGetAll('mp3files');
    mp3s.forEach(function(m) { state.mp3Buffers[m.name] = m.data; });
    if (mp3s.length > 0) {
      document.getElementById('mp3-file-label').textContent = mp3s.length + 'å€‹ã®MP3 (ğŸ’¾ ä¿å­˜æ¸ˆ)';
      document.getElementById('mp3-file-label').classList.add('loaded');
      renderMp3List();
    }
    updateStorageInfo();
    if (schedules.length > 0 || mp3s.length > 0) showToast('ğŸ’¾ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
  } catch (e) { console.warn('Load failed:', e); }
}

async function updateStorageInfo() {
  try {
    var schedules = await dbGetAll('schedules');
    var mp3s = await dbGetAll('mp3files');
    var totalSize = 0;
    mp3s.forEach(function(m) { totalSize += m.data.byteLength; });
    document.getElementById('storage-info').textContent =
      'ğŸ’¾ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: ' + schedules.length + 'ä»¶ / MP3: ' + mp3s.length + 'ä»¶ (' + (totalSize / 1048576).toFixed(1) + 'MB)';
  } catch (e) { document.getElementById('storage-info').textContent = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—'; }
}

async function clearAllData() {
  if (!confirm('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await dbClear('schedules');
  await dbClear('mp3files');
  state.mp3Buffers = {};
  state.mp3BlobUrls = {};
  state.audioElements = {};
  COURTS.forEach(function(court) {
    state.courts[court.id].announcements = [];
    state.courts[court.id].announced = new Set();
    document.getElementById('sched-label-' + court.id).textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ';
    document.getElementById('sched-label-' + court.id).classList.remove('loaded');
    updateNextAnnounce(court.id);
  });
  document.getElementById('mp3-file-label').textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰';
  document.getElementById('mp3-file-label').classList.remove('loaded');
  document.getElementById('mp3-list').innerHTML = '';
  updateStorageInfo();
  showToast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===============================================
// State
// ===============================================
var COURTS = [
  { id: 'court1', name: 'A', label: 'Aã‚³ãƒ¼ãƒˆ', color: '--court-a' },
  { id: 'court2', name: 'B', label: 'Bã‚³ãƒ¼ãƒˆ', color: '--court-b' },
  { id: 'court3', name: 'C', label: 'Cã‚³ãƒ¼ãƒˆ', color: '--court-c' },
  { id: 'court4', name: 'D', label: 'Dã‚³ãƒ¼ãƒˆ', color: '--court-d' },
];

var state = {
  courts: {},
  mp3Buffers: {},      // filename -> ArrayBuffer (for IndexedDB)
  mp3BlobUrls: {},     // filename -> Blob URL
  audioElements: {},   // filename -> Audio element (pre-created & unlocked)
  logs: []
};

// ===============================================
// iOS Audio Strategy
//
// iOS blocks audio that isn't triggered by a user gesture.
// setInterval callbacks are NOT user gestures.
//
// Solution:
// 1. On user tap (initAudio), create an Audio element for EACH MP3
// 2. Call play() on each â†’ this "unlocks" the element (iOS remembers)
// 3. Immediately pause() and reset
// 4. When timer needs to play: set currentTime=0, call play()
//    â†’ iOS allows this because the element was already unlocked
// ===============================================

var audioUnlocked = false;

function initAudio() {
  if (audioUnlocked) return;

  // Create Blob URLs from ArrayBuffers
  for (var name in state.mp3Buffers) {
    if (!state.mp3BlobUrls[name]) {
      var blob = new Blob([state.mp3Buffers[name]], { type: 'audio/mpeg' });
      state.mp3BlobUrls[name] = URL.createObjectURL(blob);
    }
  }

  // Create & unlock Audio elements for each MP3
  var names = Object.keys(state.mp3BlobUrls);
  var unlockCount = 0;

  names.forEach(function(name) {
    if (state.audioElements[name]) return; // already created

    var audio = new Audio();
    audio.setAttribute('playsinline', '');
    audio.preload = 'auto';
    audio.src = state.mp3BlobUrls[name];

    // Unlock: play then immediately pause
    // iOS needs this from a direct user gesture handler
    var p = audio.play();
    if (p && p.then) {
      p.then(function() {
        audio.pause();
        audio.currentTime = 0;
        unlockCount++;
      }).catch(function() {
        // Some browsers may reject, that's ok
        unlockCount++;
      });
    } else {
      audio.pause();
      audio.currentTime = 0;
      unlockCount++;
    }

    state.audioElements[name] = audio;
  });

  audioUnlocked = true;
  updateAudioBanner();
  showToast('ğŸ”Š éŸ³å£°æœ‰åŠ¹åŒ–å®Œäº†ï¼ï¼ˆ' + names.length + 'å€‹ï¼‰');
}

function updateAudioBanner() {
  var banner = document.getElementById('audio-banner');
  var text = document.getElementById('audio-banner-text');
  if (audioUnlocked) {
    banner.className = 'audio-banner ready';
    text.textContent = 'âœ“ éŸ³å£°æœ‰åŠ¹ â€” ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãŒå†ç”Ÿã•ã‚Œã¾ã™';
    banner.onclick = null;
  }
}

// Play audio using pre-unlocked Audio element
function playAudio(fileName, courtId) {
  if (!state.mp3Buffers[fileName]) {
    addLog(courtId, 'âš  ãƒ•ã‚¡ã‚¤ãƒ«æœªç™»éŒ²: ' + fileName);
    return;
  }
  if (!audioUnlocked) {
    addLog(courtId, 'âš  éŸ³å£°æœªæœ‰åŠ¹åŒ–: ' + fileName);
    return;
  }

  var audio = state.audioElements[fileName];
  if (audio) {
    // Reuse the pre-unlocked element
    audio.currentTime = 0;
    var p = audio.play();
    if (p && p.then) {
      p.then(function() {
        addLog(courtId, 'â™ª ' + fileName);
      }).catch(function(err) {
        addLog(courtId, 'âš  å†ç”Ÿå¤±æ•—: ' + fileName + ' (' + err.message + ')');
      });
    }
  } else {
    // Fallback: create new Audio (may not work on iOS from timer)
    var url = state.mp3BlobUrls[fileName];
    if (!url) {
      var blob = new Blob([state.mp3Buffers[fileName]], { type: 'audio/mpeg' });
      url = URL.createObjectURL(blob);
      state.mp3BlobUrls[fileName] = url;
    }
    var newAudio = new Audio(url);
    var p2 = newAudio.play();
    if (p2 && p2.then) {
      p2.then(function() { addLog(courtId, 'â™ª ' + fileName); })
        .catch(function() { addLog(courtId, 'âš  å†ç”Ÿå¤±æ•—: ' + fileName); });
    }
  }
}

function testAudio() {
  initAudio();
  var names = Object.keys(state.mp3Buffers);
  if (names.length === 0) { showToast('âš  MP3ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
  var name = names[0];
  var audio = state.audioElements[name];
  if (audio) {
    audio.currentTime = 0;
    audio.play().then(function() {
      showToast('ğŸ”Š ãƒ†ã‚¹ãƒˆ: ' + name);
    }).catch(function() {
      showToast('âš  å†ç”Ÿå¤±æ•—');
    });
  }
}

// ===============================================
// Init UI
// ===============================================
function initUI() {
  var container = document.getElementById('courts-container');
  var scheduleInputs = document.getElementById('schedule-inputs');

  COURTS.forEach(function(court) {
    state.courts[court.id] = { timer: null, elapsed: 0, status: 'stopped', announcements: [], announced: new Set() };

    var card = document.createElement('div');
    card.className = 'court-card';
    card.style.setProperty('--accent', 'var(' + court.color + ')');
    card.setAttribute('data-label', court.name);
    card.innerHTML = '<div class="court-label"><span class="dot"></span>' + court.label +
      '<span class="status" id="status-' + court.id + '">åœæ­¢ä¸­</span></div>' +
      '<div class="timer-display" id="timer-' + court.id + '">00:00:00</div>' +
      '<div class="court-buttons">' +
      '<button class="court-btn btn-start" onclick="startCourt(\'' + court.id + '\')">â–¶ é–‹å§‹</button>' +
      '<button class="court-btn btn-pause" onclick="pauseCourt(\'' + court.id + '\')">â¸ ä¸€æ™‚åœæ­¢</button>' +
      '<button class="court-btn btn-reset" onclick="resetCourt(\'' + court.id + '\')">â†º ãƒªã‚»ãƒƒãƒˆ</button></div>' +
      '<div class="next-announce" id="next-' + court.id + '">' +
      '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>' +
      '<span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœªè¨­å®š</span></div>';
    container.appendChild(card);

    var row = document.createElement('div');
    row.className = 'file-row';
    row.innerHTML = '<div class="file-label" style="color:var(' + court.color + ');font-family:Oswald,sans-serif;letter-spacing:1px">' + court.label + '</div>' +
      '<div class="file-input-wrap"><div class="file-name" id="sched-label-' + court.id + '" onclick="document.getElementById(\'sched-input-' + court.id + '\').click()">ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</div>' +
      '<input type="file" id="sched-input-' + court.id + '" accept=".txt,text/plain" onchange="handleScheduleFile(\'' + court.id + '\',this)"></div>';
    scheduleInputs.appendChild(row);
  });
}

// ===============================================
// Helpers
// ===============================================
function formatTime(s) {
  return String(Math.floor(s / 3600)).padStart(2, '0') + ':' +
    String(Math.floor((s % 3600) / 60)).padStart(2, '0') + ':' +
    String(s % 60).padStart(2, '0');
}
function parseTime(str) {
  var p = str.trim().split(':');
  if (p.length === 3) return parseInt(p[0]) * 3600 + parseInt(p[1]) * 60 + parseInt(p[2]);
  if (p.length === 2) return parseInt(p[0]) * 60 + parseInt(p[1]);
  return 0;
}
function getCourtLabel(id) { var c = COURTS.find(function(x) { return x.id === id; }); return c ? c.label : id; }

// ===============================================
// File Handling
// ===============================================
function handleScheduleFile(courtId, input) {
  var file = input.files[0];
  if (!file) return;
  var fileName = file.name;
  var reader = new FileReader();
  reader.onload = function(e) {
    var anns = [];
    e.target.result.split('\n').forEach(function(line) {
      line = line.trim();
      if (!line) return;
      var parts = line.split('\t');
      if (parts.length >= 2) anns.push({ time: parseTime(parts[0]), timeStr: parts[0].trim(), fileName: parts[1].trim() });
    });
    anns.sort(function(a, b) { return a.time - b.time; });
    state.courts[courtId].announcements = anns;
    state.courts[courtId].announced = new Set();
    dbPut('schedules', { courtId: courtId, fileName: fileName, announcements: anns }).then(updateStorageInfo);
    document.getElementById('sched-label-' + courtId).textContent = fileName + ' ğŸ’¾';
    document.getElementById('sched-label-' + courtId).classList.add('loaded');
    updateNextAnnounce(courtId);
    showToast(getCourtLabel(courtId) + ' ä¿å­˜å®Œäº†ï¼ˆ' + anns.length + 'ä»¶ï¼‰');
  };
  reader.readAsText(file, 'UTF-8');
}

function handleMp3Files(input) {
  var files = input.files;
  if (!files.length) return;
  var loaded = 0, total = files.length;
  for (var i = 0; i < files.length; i++) {
    (function(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        state.mp3Buffers[file.name] = e.target.result;
        dbPut('mp3files', { name: file.name, data: e.target.result });

        // If audio already unlocked, also create Audio element for new file
        if (audioUnlocked) {
          var blob = new Blob([e.target.result], { type: 'audio/mpeg' });
          var url = URL.createObjectURL(blob);
          state.mp3BlobUrls[file.name] = url;
          var audio = new Audio(url);
          audio.setAttribute('playsinline', '');
          audio.preload = 'auto';
          var p = audio.play();
          if (p && p.then) p.then(function() { audio.pause(); audio.currentTime = 0; }).catch(function() {});
          state.audioElements[file.name] = audio;
        }

        loaded++;
        if (loaded === total) {
          document.getElementById('mp3-file-label').textContent = Object.keys(state.mp3Buffers).length + 'å€‹ã®MP3 (ğŸ’¾ ä¿å­˜æ¸ˆ)';
          document.getElementById('mp3-file-label').classList.add('loaded');
          renderMp3List();
          updateStorageInfo();
          showToast(total + 'å€‹ã®MP3ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }
      };
      reader.readAsArrayBuffer(file);
    })(files[i]);
  }
}

function renderMp3List() {
  document.getElementById('mp3-list').innerHTML = Object.keys(state.mp3Buffers).map(function(n) {
    var mb = (state.mp3Buffers[n].byteLength / 1048576).toFixed(2);
    return '<div style="font-size:11px;color:var(--text-dim);padding:3px 0">âœ“ ' + n + ' (' + mb + 'MB)</div>';
  }).join('');
}

// ===============================================
// Timer
// ===============================================
function startCourt(courtId) {
  var court = state.courts[courtId];
  if (court.status === 'running') return;

  // IMPORTANT: initAudio on user gesture (Start button tap)
  initAudio();

  court.status = 'running';
  court.timer = setInterval(function() { tick(courtId); }, 1000);
  checkAnnouncements(courtId);
  updateCourtUI(courtId);
}

function pauseCourt(courtId) {
  var court = state.courts[courtId];
  if (court.status !== 'running') return;
  court.status = 'paused';
  clearInterval(court.timer);
  court.timer = null;
  updateCourtUI(courtId);
}

function resetCourt(courtId) {
  var court = state.courts[courtId];
  court.status = 'stopped';
  if (court.timer) clearInterval(court.timer);
  court.timer = null;
  court.elapsed = 0;
  court.announced = new Set();
  updateCourtUI(courtId);
}

function tick(courtId) {
  var court = state.courts[courtId];
  court.elapsed++;
  document.getElementById('timer-' + courtId).textContent = formatTime(court.elapsed);
  checkAnnouncements(courtId);
  if (court.announcements.length > 0) {
    var lastTime = court.announcements[court.announcements.length - 1].time;
    if (court.elapsed >= lastTime) {
      setTimeout(function() { resetCourt(courtId); }, 3000);
    }
  }
  updateNextAnnounce(courtId);
}

function checkAnnouncements(courtId) {
  var court = state.courts[courtId];
  court.announcements.forEach(function(ann) {
    if (ann.time === court.elapsed && !court.announced.has(ann.time)) {
      court.announced.add(ann.time);
      playAudio(ann.fileName, courtId);
    }
  });
}

// ===============================================
// UI
// ===============================================
function updateCourtUI(courtId) {
  var court = state.courts[courtId];
  var timerEl = document.getElementById('timer-' + courtId);
  var statusEl = document.getElementById('status-' + courtId);
  timerEl.textContent = formatTime(court.elapsed);
  timerEl.className = 'timer-display' + (court.status === 'running' ? ' running' : '');
  if (court.status === 'running') { statusEl.textContent = 'è¨ˆæ¸¬ä¸­'; statusEl.className = 'status running running-indicator'; }
  else if (court.status === 'paused') { statusEl.textContent = 'ä¸€æ™‚åœæ­¢'; statusEl.className = 'status paused'; }
  else { statusEl.textContent = 'åœæ­¢ä¸­'; statusEl.className = 'status'; }
  updateNextAnnounce(courtId);
}

function updateNextAnnounce(courtId) {
  var court = state.courts[courtId];
  var el = document.getElementById('next-' + courtId);
  var anns = court.announcements;
  var svg = '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
  if (anns.length === 0) { el.innerHTML = svg + '<span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœªè¨­å®š</span>'; return; }
  var next = anns.find(function(a) { return a.time > court.elapsed; });
  if (next) { el.innerHTML = svg + ' æ¬¡: <span class="time">' + next.timeStr + '</span> â†’ ' + next.fileName; }
  else { el.innerHTML = svg + '<span>å…¨ã‚¢ãƒŠã‚¦ãƒ³ã‚¹å®Œäº†</span>'; }
}

// ===============================================
// Log
// ===============================================
function addLog(courtId, msg) {
  var court = COURTS.find(function(c) { return c.id === courtId; });
  var now = new Date();
  var t = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
  state.logs.unshift({ courtName: court.name, color: court.color, time: t, message: msg });
  renderLogs();
}
function renderLogs() {
  var c = document.getElementById('log-container');
  if (state.logs.length === 0) { c.innerHTML = '<div class="log-empty">ã¾ã å†ç”Ÿè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  c.innerHTML = '<div class="log-list">' + state.logs.map(function(l) {
    return '<div class="log-entry"><span class="log-time">' + l.time + '</span><span class="log-court" style="background:var(' + l.color + ')">' + l.courtName + '</span><span class="log-msg">' + l.message + '</span></div>';
  }).join('') + '</div>';
}
function clearLog() { state.logs = []; renderLogs(); }

// ===============================================
// Nav & Toast & WakeLock
// ===============================================
function switchPage(page) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-tab')[['timer', 'settings', 'log'].indexOf(page)].classList.add('active');
}
function showToast(msg) {
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(function() { el.classList.remove('show'); }, 2500);
}
async function requestWakeLock() {
  try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch (e) {}
}

// ===============================================
// Boot
// ===============================================
initUI();
openDB().then(function() { loadSavedData(); });
requestWakeLock();
document.addEventListener('visibilitychange', function() { if (document.visibilityState === 'visible') requestWakeLock(); });
</script>
</body>
</html>
